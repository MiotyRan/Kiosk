<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Brasserie Claouey - Commande</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <script src="../static/js/config.js"></script>
        <style>
            /* style McDonald's custom */
            .mcdo-red { background-color: #da020e; }
            .mcdo-yellow { background-color: #ffc72c; }
            .mcdo-green { background-color: #27ae60; }
            .product-card:hover { transform: scale(1.02); }
            .product-card { transition: all 0.3s ease; }

            /* Animation */
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .slide-in { animation: slideIn 0.3s ease-out; }

            /* Interface tactile optimis√© pour 22" */
            body { font-size: 18px; }
            .btn-touch {
                min-height: 80px;
                font-size: 20px;
                font-weight: bold;
            }

            /* style panier flottant */
            .cart-floating {
                position: fixed;
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
                z-index: 1000;
            }
        </style>
    </head>

    <body class="bg-gray-50">
        <!-- header McDonal's -->
        <header class="mcdo-red text-white shadow-lg">
            <div class="container mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="text-3xl font-bold">Brasserie Claouey</div>
                        <div class="text-sm opacity-90">Commande rapide</div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- statut connexion -->
                        <div id="connection-status" class="bg-green-500 px-3 py-1 rounded-full text-sm">En ligne</div>
                        <!-- Mode de service actuel -->
                        <div id="service-mode-indicator" class="bg-yellow-500 text-black px-4 py-2 rounded-lg hidden">
                            <i class="fas-fa-info-circle mr-2"></i>
                            <span id="service-mode-text"></span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Bar de progression -->
        <div class="bg-white border-b">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-center space-x-8">
                    <div id="step1" class="flex items-center step-inticator active">
                        <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-black font-bold">1</div>
                        <span class="ml-2 font-semibold">Mode de Service</span>
                    </div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step2" class="flex items-center step-inticator">
                        <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-bold">2</div>
                        <span class="ml-2 font-semibold">Selection</span>
                    </div>
                    <div class="w-16 h-1 bg-gray-300"></div>
                    <div id="step3" class="flex items-center step-inticator">
                        <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-gray-600 font-bold">3</div>
                        <span class="ml-2 font-semibold">Paiement</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteneur principal -->
        <main class="container mx-auto px-6 py-8">
            <!-- Etape 1: selection du mode de service -->
            <div id="step-service-mode" class="screen slide-in">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-4">Comment souhaitez-vous √™tre servi ?</h1>
                    <p>Choisissez votre mode de service</p>
                </div>

                <div class="grid grid-cols-2 gap-12 max-w-4xl mx-auto">
                    <!-- sur place -->
                    <button onclick="selectServiceMode('sur_place')"
                            class="btn-touch bg-white rounded-xl shadow-lg hover:shadow-xl p-8 text-center border-4 border-transparent hover:border-yellow-400 transition-all">
                        <div class="text-8xl mb-4">üçΩÔ∏è</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Sur place</h2>
                        <p class="text-lg text-gray-600">Profitez votre repas dans notre √©tablissement</p>
                        <div class="mt-4 text-sm text-blue-600">Choisissez votre table</div>
                    </button>

                    <!-- √† emproter -->
                    <button onclick="selectServiceMode('a_emporter')"
                            class="btn-touch bg-white rounded-xl shadow-lg hover:shadow-xl p-8 text-center border-4 border-transparent hover:border-yellow-400 transition-all">
                        <div class="text-8xl mb-4">ü•°</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">A emproter</h2>
                        <p class="text-lg text-gray-600">Commandez et r√©cuprer votre commande</p>
                        <div class="mt-4 text-sm text-blue-600">Pr√©paration rapide</div>
                    </button>
                </div>
            </div>

            <!-- Selection table si sur place -->
            <div id="step-table-selection" class="screen hidden slide-in">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-4">S√©lectionnez votre table</h1>
                    <p class="text-xl text-gray-600">Choisissez le num√©ro de votre table</p>
                </div>

                <div class="grid grid-cols-5 gap-6 max-w-6xl mx-auto mb-8">
                    <!-- tables g√©n√©r√©es dynamiquement -->
                    <div id="table-grid"></div>
                </div>

                <div class="text-center">
                    <button onclick="backToServiceMode()" class="btn-touch bg-gray-300 hover:bg-gray-400 text-gray-800 px-8 py-4 rounded-lg mr-4">
                        <i class="fas fa-arrow-left mr-2"></i>Retour
                    </button>
                </div>
            </div>

            <!-- Etape 2: gestion allerg√®ne -->
            <div id="step-allergens" class="screen hidden slide-in">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-4">Avez-vous des allergies ?</h1>
                    <p class="text-xl text-gray-600">Nous filtrerons automatiquement les produits adapt√©s</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-4xl mx-auto mb-8">
                    <div class="grid grid-cols-3 gap-4 mb-6" id="allergen-grid">
                        <!-- Allerg√®nes g√©n√©r√©s dynamiquement -->
                    </div>
                    
                    <div class="flex justify-center space-x-4">
                        <button onclick="skipAllergens()" class="btn-touch bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-lg">
                            <i class="fas fa-check mr-2"></i>Aucune allergie
                        </button>
                        <button onclick="confirmAllergens()" class="btn-touch bg-yellow-500 hover:bg-yellow-600 text-black px-8 py-4 rounded-lg">
                            <i class="fas fa-shield-alt mr-2"></i>Confirmer mes allergies
                        </button>
                    </div>
                </div>
            </div>

            <!-- Etape 2: menu et selection produit -->
            <div id="step-menu" class="screen hidden">
                <div class="flex gap-8">
                    <!-- Sidebar Cat√©gories -->
                    <div class="w-1/4">
                        <div class="sticky top-4">
                            <h2 class="text-2xl font-bold mb-6 text-gray-800">Cat√©gories</h2>
                            <div class="space-y-3" id="categories-sidebar">
                                <!-- Cat√©gories g√©n√©r√©es dynamiquement -->
                            </div>
                            
                            <!-- Informations client -->
                            <div class="mt-8 p-4 bg-white rounded-lg shadow">
                                <h3 class="font-bold mb-3">Vos informations</h3>
                                <input type="text" id="customerName" 
                                    class="w-full p-3 border rounded-lg mb-3" 
                                    placeholder="Votre nom *" required>
                                <input type="email" id="customerEmail" 
                                    class="w-full p-3 border rounded-lg mb-3" 
                                    placeholder="Email (optionnel)">
                                <input type="tel" id="customerPhone" 
                                    class="w-full p-3 border rounded-lg" 
                                    placeholder="T√©l√©phone (optionnel)">
                            </div>
                        </div>
                    </div>
                    <!-- Main Menu Area -->
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800" id="category-title">Tous nos produits</h2>
                            <div class="flex space-x-2">
                                <!-- Filtres actifs -->
                                <div id="active-filters" class="flex space-x-2"></div>
                            </div>
                        </div>
                        
                        <!-- Grille Produits -->
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-6" id="products-grid">
                            <!-- Produits g√©n√©r√©s dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Etape 3: r√©capitulatif et paiement -->
            <div id="step-payment" class="screen hidden slide-in">
                <div class="grid grid-cols-2 gap-12">
                    <!-- R√©capitulatif Commande -->
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800">R√©capitulatif</h2>
                        
                        <!-- Infos service -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold">Mode de service:</span>
                                <span id="summary-service-mode" class="font-bold"></span>
                            </div>
                            <div id="summary-table" class="hidden">
                                <span class="font-semibold">Table:</span>
                                <span id="summary-table-number" class="font-bold"></span>
                            </div>
                            <div>
                                <span class="font-semibold">Client:</span>
                                <span id="summary-customer-name" class="font-bold"></span>
                            </div>
                        </div>
                        
                        <!-- Items -->
                        <div class="space-y-4 mb-6" id="summary-items">
                            <!-- Items g√©n√©r√©s dynamiquement -->
                        </div>
                        
                        <!-- Totaux -->
                        <div class="border-t pt-4">
                            <div class="flex justify-between text-lg">
                                <span>Sous-total HT:</span>
                                <span id="summary-subtotal-ht">0.00 ‚Ç¨</span>
                            </div>
                            <div class="flex justify-between text-lg">
                                <span>TVA (20%):</span>
                                <span id="summary-tva">0.00 ‚Ç¨</span>
                            </div>
                            <div class="flex justify-between text-2xl font-bold text-green-600 mt-2 pt-2 border-t">
                                <span>Total TTC:</span>
                                <span id="summary-total-ttc">0.00 ‚Ç¨</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paiement -->
                    <div class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800">Mode de Paiement</h2>
                        
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Paiement Esp√®ces -->
                            <button onclick="selectPaymentMethod('cash')" id="btn-payment-cash"
                                    class="btn-touch bg-green-500 hover:bg-green-600 text-white rounded-xl p-6 text-left border-4 border-transparent">
                                <div class="flex items-center">
                                    <div class="text-4xl mr-4">üíµ</div>
                                    <div>
                                        <div class="text-xl font-bold">Esp√®ces</div>
                                        <div class="text-sm opacity-90">Paiement au comptoir</div>
                                        <div class="text-xs mt-1 bg-green-700 inline-block px-2 py-1 rounded">Ticket imm√©diat</div>
                                    </div>
                                </div>
                            </button>
                            
                            <!-- Paiement Carte -->
                            <button onclick="selectPaymentMethod('card')" id="btn-payment-card"
                                    class="btn-touch bg-blue-500 hover:bg-blue-600 text-white rounded-xl p-6 text-left border-4 border-transparent">
                                <div class="flex items-center">
                                    <div class="text-4xl mr-4">üí≥</div>
                                    <div>
                                        <div class="text-xl font-bold">Carte Bancaire</div>
                                        <div class="text-sm opacity-90">VIVA Wallet s√©curis√©</div>
                                        <div class="text-xs mt-1 bg-blue-700 inline-block px-2 py-1 rounded">Paiement instantan√©</div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        
                        <!-- Actions -->
                        <div class="space-y-4 pt-6">
                            <button onclick="processOrder()" id="btn-process-order"
                                    class="btn-touch w-full mcdo-yellow hover:bg-yellow-400 text-black rounded-xl py-6 text-xl font-bold disabled:opacity-50"
                                    disabled>
                                <i class="fas fa-credit-card mr-3"></i>
                                <span id="btn-process-text">S√©lectionnez un mode de paiement</span>
                            </button>
                            
                            <button onclick="backToMenu()" 
                                    class="btn-touch w-full bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-xl py-4">
                                <i class="fas fa-arrow-left mr-2"></i>Retour au menu
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Pannier flottant -->
        <div class="cart-floating">
            <div class="bg-white rounded-xl shadow-2xl p-4 w-80" id="floating-cart">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-lg">
                        <i class="fas fa-shopping-cart text-yellow-500 mr-2"></i>
                        Panier (<span id="cart-count">0</span>)
                    </h3>
                    <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="cart-items" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                    <!-- Items du panier -->
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total:</span>
                        <span id="cart-total" class="text-green-600">0.00 ‚Ç¨</span>
                    </div>
                    
                    <button onclick="proceedToPayment()" id="btn-proceed-payment"
                            class="w-full mt-4 btn-touch bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg py-3 font-bold disabled:opacity-50"
                            disabled>
                        Continuer
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modales -->
        <!-- Personnalisation du produit -->
         <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-8 max-w-4xl w-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold" id="modal-product-name">Personnalisez votre produit</h2>
                    <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modal-product-content">
                    <!-- contenu g√©n√©r√© dynamiquement -->
                </div>
            </div>
         </div>

        <!-- Traitement de la commande -->
         <div id="processing-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
                <div class="mb-6">
                    <div class="animate-spin w-16 h-16 border-4 border-yellow-400 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <h3 class="text-2xl font-bold mb-2" id="processing-title">Traitement en cours...</h3>
                    <p class="text-gray-600" id="processing-subtitle">Veuillez patienter</p>
                </div>

                <div id="processing-steps" class="text-left space-y-2">
                    <!-- etapes generees dynamiquement -->
                </div>
            </div>
         </div>

        <!-- Toast notification -->
         <div id="toast-container" class="fixed top-4 right-4 z-50">
            <!-- toasts generes dynamiquement -->
         </div>

        <script>
            // Configuration et etat global
            let currentStep = 'service-mode';
            let serviceMode = null;
            let tableNumber = null;
            let customerInfo = {};
            let selectedAllergens = [];
            let cart = [];
            let categories = [];
            let products = [];
            let selectedPayementMethod = null;
            let currentOrder = null;

            // configuration des allerg√®nes (14 obligatoires UE)
            const ALLARGENS = {
                1: {code: 'GLU', name: 'Gluten', icon:'üåæ'},
                2: {code: 'CRU', name: 'Crustc√©s', icon: 'ü¶ê'},
                3: {code: 'EGG', name: 'Oeufs', icon: 'ü•ö'},
                4: {code: 'FSH', name: 'Poisson', icon: 'üêü'},
                5: {code: 'PNT', name: 'Arachides', icon: 'ü•ú'},
                6: {code: 'SOY', name: 'Soja', icon: 'üå±'},
                7: {code: 'MLK', name: 'Lait', icon: 'ü•õ'},
                8: {code: 'NUT', name: 'Fruits √† coq', icon: 'üå∞'},
                9: {code: 'CEL', name: 'C√©l√©ri', icon: 'ü•¨'},
                10: {code: 'MUS', name: 'Moutarde', icon: 'üü°'},
                11: {code: 'SES', name: 'Graines de s√©same', icon: '‚ö™'},
                12: {code: 'SUL', name: 'Sulfites', icon: 'üß™'},
                13: {code: 'LUP', name: 'Lupin', icon: 'üåø'},
                14: {code: 'MOL', name: 'Mollusques', icon: 'ü¶™'},
            }

            // limites business
            const LIMIT = {
                max_items_per_order: 50,
                max_quantity_per_item: 20,
                tva: 0.20
            }

            // API URL (depuis config.js ou fallback)
            const API_URL = window.CONFIG?.API_URL || 'http://localhost:8000';

            // initialisation
            document.addEventListener('DOMContentLoaded', () => {
                showStep('step-service-mode');
                loadCategoriesAndProducts();
                generateTableGrid();
                generateAllergenGrid();
                updateCarteUI();

                // event listener
                setupEventListeners();
            });

            // configuration des event listeners
            function setupEventListeners() {
                // validation du nom client
                document.getElementById('customerName').addEventListener('input', updateCustomerInfo);
                document.getElementById('customerEmail').addEventListener('input', updateCustomerInfo);
                document.getElementById('customerPhone').addEventListener('input', updateCustomerInfo);
            }

            // Etape 1: Mode de service
            function selectServiceMode(mode) {
                serviceMode = mode;
                updateStepIndicator(1);

                if (mode === 'sur_place') {
                    showStep('step-table-selection');
                } else {
                    // √† emporter, passser aux allergenes
                    showStep('step-allergens');
                }

                updateServiceModeIndicator();
            }

            function updateServiceModeIndicator() {
                const indicator = document.getElementById('service-mode-indicator');
                const text = document.getElementById('service-mode-text')

                if (serviceMode) {
                    indicator.classList.remove('hidden');
                    if (serviceMode === 'sur_place') {
                        text.textContent = tableNumber ? `Sur place - Table ${tableNumber}` : 'Sur place';
                    } else {
                        text.textContent = 'A emporter';
                    }
                }
            }

            // generation grille des tables
            function generateTableGrid() {
                const grid = document.getElementById('table-grid');
                grid.innerHTML = '';

                // 20 tables 
                for (let i = 1; i <= 20; i++) {
                    const tableBtn = document.createElement('button');
                    tableBtn.className = 'btn-touch bg-white hover:bg-yellow-100 border-2 hover:border-yellow-400 rounded-xl p-6 text-center transition-all';
                    tableBtn.onclick = () => selectTable(i);
                    tableBtn.innerHTML = `
                        <div class="text-3xl mb-2">ü™ë</div>
                        <div class="font-bold">Table ${i}</div>
                        <div class="text-sm text-gray-500">Disponible</div>
                    `;
                    grid.appendChild(tableBtn);
                }
            }

            function selectTable(number) {
                tableNumber = number;
                updateServiceModeIndicator();
                showStep('step-allergens');
            } 

            function backToServiceMode() {
                serviceMode = null;
                tableNumber = null;
                showStep('step-service-mode');
                updateServiceModeIndicator(0);
            }

            // Etape 2: Allerg√®nes
            function generateAllergenGrid() {
                const grid = document.getElementById('allergen-grid');
                grid.innerHTML = '';

                Object.entries(ALLARGENS).forEach(([id, allergen]) => {
                    const allergenDiv = document.createElement('label');
                    allergenDiv.className = 'flex items-center p-4 border-2 rounded-lg hover:bg-red-50 cursor-pointer transition-all';
                    allergenDiv.innerHTML = `
                        <input type="checkbox" class="allergen-checkbox mr-3 w-5 h-5" 
                            value="${id}" onchange="toggleAllergen(${id})">
                        <span class="text-2xl mr-3">${allergen.icon}</span>
                        <span class="font-medium">${allergen.name}</span>
                    `;
                    grid.appendChild(allergenDiv);
                });
            }
            
            function toggleAllergen(id) {
                const checkbox = document.querySelector(`input[value="${id}"]`);
                if (checkbox.checked) {
                    if (!selectedAllergens.includes(id)) {
                        selectedAllergens.push(id);
                    }
                } else {
                    selectedAllergens = selectedAllergens.filter(a => a != id);
                }
            }

            function skipAllergens() {
                selectedAllergens = [];
                showStep('step-menu');
                updateServiceModeIndicator(2);
            }

            function confirmAllergens() {
                showToast(`${selectedAllergens.length} allergies s√©lectionn√©es`, 'info');
                showStep('step-menu');
                updateServiceModeIndicator(2);
                // filtrer les produits
                filterProductsByAllergen();
            }

            // == Chargement des donn√©es ==
            async function loadCategoriesAndProducts() {
                try {
                    // charger categories
                    const categoriesResponse = await fetch(`${API_URL}/api/catalog/categories`);
                    if (categoriesResponse.ok) {
                        const categoriesData = await categoriesResponse.json();
                        categories = categoriesData.categories || categoriesData;
                        displayCategories();
                    }

                    // charger produits 
                    const productsResponse = await fetch(`${API_URL}/api/catalog/products`);
                    if (productsResponse.ok) {
                        const productsData = await productsResponse.json();
                        products = productsData.products || productsData;
                        displayProducts();
                    }
                } catch (error) {
                    console.error('Erreur chargement donn√©es:', error);
                    showToast('Erreur de chargement du catalogue', 'error');
                }
            }

            // affichage des cat√©gories
            function displayCategories() {
                const sidebar = document.getElementById('categories-sidebar');
                sidebar.innerHTML = '';

                // bouton "Tous"
                allBtn.className = 'w-full text-left p-4 rounded-lg bg-yellow-500 text-black font-bold';
                allBtn.onclick = () => filterByCategory(null);
                allBtn.innerHTML = '<i class="fas fa-th-large mr-3"></i>Tous nos produits';
                sidebar.appendChild(allBtn);

                categories.forEach(category => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-4 rounded-lg bg-white hover:bg-yellow-50 border hover:border-yellow-300 transition-all';
                    btn.onclick = () => filterByCategory(category.id);
                    btn.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${category.icon || 'üç¥'}</span>
                            <span class="font-semibold">${category.name}</span>
                        </div>
                    `;
                    sidebar.appendChild(btn);
                });
            }

            // affichage des produits
            function displayProducts(filterderProducts = products) {
                const grid = document.getElementById('products-grid');
                grid.innerHTML = '';
                
                filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all cursor-pointer';
                    productCard.onclick = () => showProductModal(product);
                    
                    productCard.innerHTML = `
                        <div class="relative">
                            <img src="${product.image_url || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(product.name)}" 
                                alt="${product.name}" 
                                class="w-full h-48 object-cover">
                            ${product.is_popular ? '<div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">üî• Populaire</div>' : ''}
                            ${!product.is_safe ? '<div class="absolute top-2 right-2 bg-orange-500 text-white px-2 py-1 rounded-full text-xs">‚ö†Ô∏è</div>' : ''}
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description || 'D√©licieux produit de notre chef'}</p>
                            
                            ${product.allergens ? `
                                <div class="flex flex-wrap gap-1 mb-3">
                                    ${product.allergens.slice(0, 3).map(a => {
                                        const allergen = ALLERGENS[a.allergen_id];
                                        return `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded" title="${allergen.name}">
                                            ${allergen.icon} ${allergen.code}
                                        </span>`;
                                    }).join('')}
                                    ${product.allergens.length > 3 ? '<span class="text-xs text-gray-500">+' + (product.allergens.length - 3) + '</span>' : ''}
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-bold text-green-600">${(product.base_price || 0).toFixed(2)} ‚Ç¨</span>
                                <button class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-bold">
                                    <i class="fas fa-plus mr-1"></i>Ajouter
                                </button>
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(productCard);
                }); 
            }

            // filtrage par categorie
            function filterByCategory(categoryId) {
                const filtered = categoryId ? products.filter(p => p.category_id === categoryId) : products;
                displayProducts(filtered);
                
                // Mettre √† jour le titre
                const title = document.getElementById('category-title');
                if (categoryId) {
                    const category = categories.find(c => c.id === categoryId);
                    title.textContent = category ? category.name : 'Cat√©gorie';
                } else {
                    title.textContent = 'Tous nos produits';
                }
                
                // Mettre √† jour les boutons cat√©gories
                document.querySelectorAll('#categories-sidebar button').forEach(btn => {
                    btn.className = btn.className.replace('bg-yellow-500 text-black', 'bg-white hover:bg-yellow-50 border hover:border-yellow-300');
                });
            }

            // fitrage par allergenes
            function filterProductsByAllergens() {
                if (selectedAllergens.length === 0) {
                    displayProducts();
                    return;
                }
                
                // Simuler le filtrage (dans la vraie version, appel API)
                const safeProducts = products.filter(product => {
                    // Logique de filtrage bas√©e sur les allerg√®nes
                    return !product.allergens || !product.allergens.some(a => 
                        selectedAllergens.includes(a.allergen_id)
                    );
                });
                
                displayProducts(safeProducts);
                
                showToast(`${safeProducts.length} produits adapt√©s √† vos allergies`, 'success');
            }

            // == Modal produit ==
            function showProductModal(product) {
                const modal = document.getElementById('product-modal');
                const name = document.getElementById('modal-product-name');
                const content = document.getElementById('modal-product-content');
                
                name.textContent = product.name;
                
                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <img src="${product.image_url || 'https://via.placeholder.com/400x300'}" 
                                alt="${product.name}" 
                                class="w-full rounded-lg">
                        </div>
                        <div>
                            <p class="text-lg mb-4">${product.description || 'D√©licieux produit de notre chef'}</p>
                            <div class="text-3xl font-bold text-green-600 mb-6">${(product.base_price || 0).toFixed(2)} ‚Ç¨</div>
                            
                            <!-- Quantit√© -->
                            <div class="mb-6">
                                <label class="block font-bold mb-2">Quantit√©</label>
                                <div class="flex items-center space-x-4">
                                    <button onclick="changeQuantity(-1)" class="bg-gray-200 hover:bg-gray-300 w-10 h-10 rounded">-</button>
                                    <span id="modal-quantity" class="text-xl font-bold">1</span>
                                    <button onclick="changeQuantity(1)" class="bg-gray-200 hover:bg-gray-300 w-10 h-10 rounded">+</button>
                                </div>
                            </div>
                            
                            <!-- Instructions sp√©ciales -->
                            <div class="mb-6">
                                <label class="block font-bold mb-2">Instructions sp√©ciales</label>
                                <textarea id="modal-instructions" class="w-full p-3 border rounded-lg" rows="3" 
                                        placeholder="Exemple: Sans oignons, bien cuit, sauce √† part..."></textarea>
                            </div>
                            
                            <!-- Actions -->
                            <div class="space-y-4">
                                <button onclick="addProductToCart('${product.id}')" 
                                        class="w-full btn-touch bg-yellow-500 hover:bg-yellow-600 text-black rounded-lg py-4 text-xl font-bold">
                                    <i class="fas fa-cart-plus mr-2"></i>
                                    Ajouter au panier
                                </button>
                                <button onclick="closeProductModal()" 
                                        class="w-full btn-touch bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg py-3">
                                    Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
            }

            function closeProductModal() {
                document.getElementById('product-modal').classList.add('hidden');
            }

            function changeQuantity(delta) {
                const quantitySpan = document.getElementById('modal-quantity');
                let quantity = parseInt(quantitySpan.textContent) + delta;

                if (quantity < 1) quantity = 1;
                if (quantity > LIMIT.max_quantity_per_item) quantity = LIMIT.max_quantity_per_item;

                quantitySpan.textContent = quantity;
            }

            // == Gestion panier ==
            function addProductToCart(productId) {
                const product = products.find(p => p.id === productId);
                if (!product) return;
                
                const quantity = parseInt(document.getElementById('modal-quantity').textContent);
                const instructions = document.getElementById('modal-instructions').value;
                
                // V√©rifier limite panier
                if (cart.length >= LIMITS.max_items_per_order) {
                    showToast(`Maximum ${LIMITS.max_items_per_order} articles diff√©rents`, 'error');
                    return;
                }
                
                // V√©rifier allerg√®nes
                if (!checkAllergenSafety(product)) {
                    return;
                }
                
                const existingItem = cart.find(item => 
                    item.product_id === productId && 
                    item.special_instructions === instructions
                );
                
                if (existingItem) {
                    if (existingItem.quantity + quantity > LIMITS.max_quantity_per_item) {
                        showToast(`Maximum ${LIMITS.max_quantity_per_item} unit√©s par article`, 'error');
                        return;
                    }
                    existingItem.quantity += quantity;
                    existingItem.total_price = existingItem.quantity * existingItem.unit_price;
                } else {
                    cart.push({
                        product_id: productId,
                        product_name: product.name,
                        quantity: quantity,
                        unit_price: product.base_price || 0,
                        total_price: (product.base_price || 0) * quantity,
                        special_instructions: instructions || null,
                        modifiers: [],
                        variation_id: null,
                        hiboutik_id: product.hiboutik_id || null
                    });
                }
                
                updateCartUI();
                closeProductModal();
                showToast(`${product.name} ajout√© au panier`, 'success');
            }

            function checkAllergenSafety(product) {
                if (selectedAllergens.length === 0) return true;

                const productAllergens = product.allergen || [];
                const conflicts = productAllergens.filter(pa =>
                    selectedAllergens.includes(pa.allergen_id)
                );

                if (conflicts.length > 0) {
                    const allergenName = conflicts.map(c => ALLARGENS[c.allergen_id].name);
                    return confirm(
                        `ATTENTION: Ce produit contient: ${allergenNames.join(', ')}\n\n` +
                        `Voulez-vous quand m√™me l'ajouter au panier ?`
                    );
                }
                return true;
            }

            function updateCarteUI() {
                const cartCount = document.getElementById('cart-count');
                const cartTotal = document.getElementById('cart-total');
                const cartItems = document.getElementById('cart-items');
                const btnProceed = document.getElementById('btn-proceed-payment');

                const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
                const total = cart.reduce((sum, item) => sum + item.total_price, 0);

                cartCount.textContent = itemCount;
                cartTotal.textContent = total.toFixed(2) + ' ‚Ç¨';

                // items
                if (cart.length === 0) {
                    cartItems.innerHTML = '<p class="text-gray-500 text-center py-4">Panier vide</p>';
                    btnProceed.disabled = true;
                } else {
                    cartItems.innerHTML = cart.map((item, index) => `
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <div class="flex-1">
                                <div class="font-medium">${item.product_name}</div>
                                <div class="text-sm text-gray-600">
                                    ${item.quantity} x ${item.unit_price.toFixed(2)} ‚Ç¨
                                    ${item.special_instructions ? '<br><em>' + item.special_instructions + '</em>' : ''}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-semibold">${item.total_price.toFixed(2)} ‚Ç¨</span>
                                <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                    btnProceed.disabled = false;
                }
            }

            function removeFromCart(index) {
                const cart = document.getElementById('floating-cart');
                // toggle visibility logic
            }

            function proceedToPayment() {
                updateCustomerInfo();

                if (!customerInfo.name) {
                    showToast('Veuillez saisir votre nom', 'error');
                    document.getElementById('customerName').focus();
                    return;
                }

                showStep('step-payment');
                updateStepIndicator(3);
                updatePaymentSummary();
            }

            // == Etape 3: Paiement ==
            function updatePaymentSummary() {
                // mode de service
                const serviceModeEl = document.getElementById('summary-service-mode');
                serviceModeEl.textContent = serviceMode === 'sur_place' ? 'Sur place' : 'A emporter';

                // table
                const tableDiv = document.getElementById('summary-table');
                if (serviceMode === 'sur_place' && tableNumber) {
                    tableDiv.classList.remove('hidden');
                    document.getElementById('summary-table-number').textContent = tableNumber;
                }

                // client
                document.getElementById('summary-customer-name').textContent = customerInfo.name;

                // items
                const itemsDiv = document.getElementById('summary-items');
                itemsDiv.innerHTML = cart.map(item => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                        <div>
                            <div class="font-medium">${item.product_name}</div>
                            <div class="text-sm text-gray-600">Quantit√©: ${item.quantity}</div>
                            ${item.special_instructions ? '<div class="text-xs text-blue-600"><em>' + item.special_instructions + '</em></div>' : ''}
                        </div>
                        <div class="font-bold">${item.total_price.toFixed(2)} ‚Ç¨</div>
                    </div>
                `).join('');

                // total
                const totalTTC = cart.reduce((sum, item) => sum + item.total_price, 0);
                const totalHT = totalTTC / (1 + LIMITS.tva_rate);
                const tvaAmount = totalTTC - totalHT;

                document.getElementById('summary-subtotal-ht').textContent = totalHT.toFixed(2) + ' ‚Ç¨';
                document.getElementById('summary-tva').textContent = tvaAmount.toFixed(2) + ' ‚Ç¨';
                document.getElementById('summary-total-tcc').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';
            }

            function selectedPayementMethod(method) {
                selectedPayementMethod = method;

                // update UI
                const btnCash = document.getElementById('btn-payment-cash');
                const btnCard = document.getElementById('btn-payment-card');
                const btnProcess = document.getElementById('btn-process-order');
                const btnProcessText = document.getElementById('btn-process-text');

                btnCash.classList.toggle('border-green-400', method === 'cash');
                btnCard.classList.toggle('border-green-400', method === 'card');

                btnProcess.disabled = false;
                btnProcessText.textContent = method === 'cash' ?
                    'Valider et imprimer le ticket' :
                    'Proc√©der au payment carte';
            }

            async function processOrder() {
                if (!validateOrder()) return;

                showProcessingModal();

                try {
                    // √âTAPE 1: Cr√©er la commande
                    addProcessingStep('Cr√©ation de la commande...');
                    const order = await createOrder();
                    currentOrder = order;
                    
                    addProcessingStep(`Commande ${order.order_number} cr√©√©e`);
                    
                    // √âTAPE 2: Traitement selon le mode de paiement
                    if (selectedPaymentMethod === 'cash') {
                        // Paiement esp√®ces - Les 4 √©tapes Hiboutik
                        await processCashPayment(order);
                    } else {
                        // Paiement carte - VIVA + Hiboutik
                        await processCardPayment(order);
                    }
                    
                    // Succ√®s
                    setTimeout(() => {
                        hideProcessingModal();
                        showSuccessScreen();
                        resetKiosk();
                    }, 2000);
                } catch (error) {
                    console.error('Erreur traitement:', error);
                    hideProcessingModal();
                    showToast(error.message || 'Erreur lors du traitement', 'error');
                }
            }

            function validateOrder() {
                if (cart.length === 0) {
                    showToast('Le panier est vide', 'error');
                    return false;
                }

                if (!customerInfo.name) {
                    showToast('Le nom du client est obligatoir', 'error');
                    return false;
                }

                if (serviceMode === 'sur_place' && !tableNumber) {
                    showToast('Num√©ro de table requis pour le service sur place');
                    return false;
                }

                if (!selectedPayementMethod) {
                    showToast('S√©lectionnez un mode de paiement', 'error');
                    return false;
                }

                return;
            }

            async function createOrder() {
                const orderData = {
                    items: cart,
                    customer_name: customerInfo.name,
                    customer_email: customerInfo.email || null,
                    customer_phone: customerInfo.phone || null,
                    service_mode: serviceMode,
                    total_number: serviceMode === 'sur_place' ? tableNumber : null,
                    order_type: 'kiosk',
                    payment_method: selectedPayementMethod === 'cash' ? 'cash' : 'viva_card',
                    special_notes: selectedAllergens.length > 0 ?
                        `Allergies: ${selectedAllergens.map(id => ALLERGENS[id].name).join(', ')}` : null
                };

                const response = await fetch(`${API_URL}/api/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erreur cr√©ation commande');
                }

                return await response.json();
            }

            async function processCashPayment(order) {
                addProcessingStep('Traitement paiement esp√®ces...');
                addProcessingStep('Cr√©ation vente Hiboutik...');
                addProcessingStep('Ajout produits + sortie stock...');
                addProcessingStep('Enregistrement paiement ESP...');
                addProcessingStep('Fermeture vente (caisse l√©gale)...');
                
                // Simuler les appels (dans la vraie version, appel API)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                addProcessingStep('Ticket imprim√© sur imprimante int√©gr√©e');
                addProcessingStep('Ticket envoy√© par email (si fourni)');
            }

            async function processCardPayment(order) {
                addProcessingStep('Initialisation terminal VIVA...');
                addProcessingStep('Traitement paiement carte...');
            
                // Simuler paiement VIVA
                await new Promise(resolve => setTimeout(resolve, 3000));
            
                addProcessingStep('Paiement carte valid√©');
                addProcessingStep('Cr√©ation vente Hiboutik...');
                addProcessingStep('Ajout produits + sortie stock...');
                addProcessingStep('Enregistrement paiement CB...');
                addProcessingStep('Fermeture vente (caisse l√©gale)...');
                
                addProcessingStep('Tickets imprim√©s (client + cuisine)');
            }


            // == Modales et UI ==
            function showProcessingModal() {
                const modal = document.getElementById('processing-modal');
                const stepDisplay = document.getElementById('processing-steps');

                stepDiv.innerHTML = '';
                modal.classList.remove('hidden');
            }

            function hideProcessingModal() {
                document.getElementById('processing-modal').classList.add('hidden');
            }

            function addProcessingStep(text) {
                const stepsDiv = document.getElementById('processing-steps');
                const step = document.createElement('div');
                step.className = 'flex items-center space-x-2';
                step.innerHTML = `
                    <i class="fas fa-check text-green-500"></i>
                    <span>${text}</span>
                `;
                stepsDiv.appendChild(step);
            }

            function showSuccessScreen() {
                // √âcran de remerciement
                const main = document.querySelector('main');
                main.innerHTML = `
                    <div class="text-center py-20">
                        <div class="text-8xl mb-8">üéâ</div>
                        <h1 class="text-4xl font-bold text-green-600 mb-4">Merci pour votre commande !</h1>
                        <p class="text-xl text-gray-600 mb-8">
                            ${currentOrder ? `Commande ${currentOrder.order_number}` : 'Votre commande'} a √©t√© enregistr√©e avec succ√®s
                        </p>
                        <div class="space-y-4">
                            <div class="text-lg">
                                ${serviceMode === 'sur_place' 
                                    ? `Nous vous servirons √† la table ${tableNumber}`
                                    : 'Votre commande sera pr√™te sous peu'}
                            </div>
                            <div class="text-lg font-bold text-blue-600">
                                ${selectedPaymentMethod === 'cash' 
                                    ? 'Pr√©sentez-vous au comptoir avec votre ticket'
                                    : 'Paiement confirm√© - Restez √† proximit√©'}
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <button onclick="resetKiosk()" 
                                    class="btn-touch bg-yellow-500 hover:bg-yellow-600 text-black px-8 py-4 rounded-xl text-xl font-bold">
                                <i class="fas fa-home mr-2"></i>Nouvelle commande
                            </button>
                        </div>
                    </div>
                `;
                
                // Auto-reset apr√®s 30 secondes
                setTimeout(() => {
                    resetKiosk();
                }, 30000);
            }

            function resetKiosk() {
                // Reset toutes les variables
                currentStep = 'service-mode';
                serviceMode = null;
                tableNumber = null;
                customerInfo = {};
                selectedAllergens = [];
                cart = [];
                selectedPaymentMethod = null;
                currentOrder = null;
                
                // Reset UI
                document.getElementById('customerName').value = '';
                document.getElementById('customerEmail').value = '';
                document.getElementById('customerPhone').value = '';
                
                // Recharger la page pour repartir de z√©ro
                location.reload();
            }

            // == Helpers ==
            function showStep(stepId) {
                // Masquer tous les √©crans
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                
                // Afficher l'√©cran demand√©
                document.getElementById(stepId).classList.remove('hidden');
                document.getElementById(stepId).classList.add('slide-in');
                
                currentStep = stepId;
            }

            function updateStepIndicator(step) {
                document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                    const circle = indicator.querySelector('div');
                    const text = indicator.querySelector('span');
                    
                    if (index < step) {
                        // √âtape compl√©t√©e
                        circle.className = 'w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold';
                        text.className = 'ml-2 font-semibold text-green-600';
                    } else if (index === step) {
                        // √âtape actuelle
                        circle.className = 'w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-black font-bold';
                        text.className = 'ml-2 font-semibold';
                    } else {
                        // √âtape √† venir
                        circle.className = 'w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-bold';
                        text.className = 'ml-2 text-gray-600';
                    }
                });
            }

            function updateCustomerInfo() {
                customerInfo = {
                    name: document.getElementById('customerName').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                };
            }

            function backToMenu() {
                showStep('step-menu');
                updateServiceModeIndicator(2);
            } 

            function showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');

                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500',
                    warning: 'bg-yellow-500',
                };

                toast.className = `${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg mb-2 slide-in`;
                toast.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                container.appendChild(toast);

                // auto-remove apres 5s
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 5000);
            }

        </script>

    </body>
</html>