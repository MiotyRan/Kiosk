<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brasserie Claouey - Kiosque de Commande</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Configuration Tailwind personnalis√©e */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            touch-action: manipulation;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .product-card {
            transition: all 0.3s ease-in-out;
        }
        
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .cart-badge {
            animation: pulse 2s infinite;
        }
        
        .modal {
            backdrop-filter: blur(10px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
        }
        
        .allergen-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 12px;
        }
        
        /* Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in-up {
            animation: slideInUp 0.3s ease-out;
        }
        
        /* Touch feedback */
        .touch-feedback:active {
            transform: scale(0.98);
        }
        
        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-utensils text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Brasserie Claouey</h1>
                        <p class="text-sm opacity-90">Commande en libre-service</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Indicateur de connexion -->
                    <div id="connection-indicator" class="bg-green-500 text-white px-4 py-2 rounded-full text-sm">
                        <i class="fas fa-wifi mr-2"></i>En ligne
                    </div>
                    
                    <!-- Panier -->
                    <button id="cart-button" 
                            class="relative bg-white text-blue-600 px-6 py-3 rounded-full font-semibold shadow-lg touch-feedback hover:bg-gray-50 transition-colors"
                            onclick="openCartModal()">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Panier
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center cart-badge hidden">0</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Content Principal -->
    <main class="container mx-auto px-6 py-8">
        <!-- S√©lection du mode de service -->
        <div id="service-mode-screen" class="slide-in-up">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Bienvenue !</h2>
                <p class="text-xl text-gray-600">Comment souhaitez-vous √™tre servi ?</p>
            </div>
            
            <div class="grid grid-cols-2 gap-8 max-w-4xl mx-auto">
                <button onclick="setServiceMode('sur_place')" 
                        class="group bg-white p-12 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 touch-feedback">
                    <div class="text-center">
                        <div class="bg-blue-100 w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-blue-200 transition-colors">
                            <i class="fas fa-utensils text-6xl text-blue-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">Sur Place</h3>
                        <p class="text-gray-600 text-lg">Consommez dans notre √©tablissement</p>
                    </div>
                </button>
                
                <button onclick="setServiceMode('a_emporter')" 
                        class="group bg-white p-12 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 touch-feedback">
                    <div class="text-center">
                        <div class="bg-green-100 w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-green-200 transition-colors">
                            <i class="fas fa-shopping-bag text-6xl text-green-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">√Ä Emporter</h3>
                        <p class="text-gray-600 text-lg">R√©cup√©rez votre commande</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- S√©lection de table -->
        <div id="table-selection-screen" class="hidden slide-in-up">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Choisissez votre table</h2>
                <p class="text-lg text-gray-600">S√©lectionnez le num√©ro de votre table</p>
            </div>
            
            <div id="table-grid" class="grid grid-cols-5 gap-4 max-w-4xl mx-auto">
                <!-- Tables g√©n√©r√©es dynamiquement -->
            </div>
            
            <div class="text-center mt-8">
                <button onclick="goBackToServiceMode()" 
                        class="bg-gray-300 text-gray-700 px-8 py-4 rounded-xl text-lg font-semibold hover:bg-gray-400 touch-feedback">
                    <i class="fas fa-arrow-left mr-2"></i>Retour
                </button>
            </div>
        </div>

        <!-- S√©lection des allerg√®nes -->
        <div id="allergen-selection-screen" class="hidden slide-in-up">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Allergies et intol√©rances</h2>
                <p class="text-lg text-gray-600 mb-6">S√©lectionnez vos allergies pour filtrer automatiquement le menu</p>
            </div>
            
            <div id="allergen-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-w-6xl mx-auto mb-8">
                <!-- Allerg√®nes g√©n√©r√©s dynamiquement -->
            </div>
            
            <div class="text-center space-x-4">
                <button onclick="skipAllergenSelection()" 
                        class="bg-gray-300 text-gray-700 px-8 py-4 rounded-xl text-lg font-semibold hover:bg-gray-400 touch-feedback">
                    Aucune allergie
                </button>
                <button onclick="confirmAllergenSelection()" 
                        class="btn-primary text-white px-8 py-4 rounded-xl text-lg font-semibold hover:opacity-90 touch-feedback">
                    Confirmer et filtrer le menu
                </button>
            </div>
        </div>

        <!-- Menu principal -->
        <div id="main-menu-screen" class="hidden">
            <!-- Barre de cat√©gories -->
            <div class="mb-8">
                <div id="categories-nav" class="flex space-x-4 overflow-x-auto pb-4">
                    <!-- Cat√©gories g√©n√©r√©es dynamiquement -->
                </div>
            </div>

            <!-- Grille des produits -->
            <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Produits g√©n√©r√©s dynamiquement -->
            </div>
        </div>
    </main>

    <!-- Modal Panier -->
    <div id="cart-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl max-w-2xl w-full mx-4 max-h-screen overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-gray-800">Votre Panier</h3>
                    <button onclick="closeCartModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="max-h-96 overflow-y-auto p-6">
                <div id="cart-items" class="space-y-4">
                    <!-- Items du panier -->
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-shopping-cart text-6xl mb-4 opacity-50"></i>
                        <p class="text-xl">Votre panier est vide</p>
                    </div>
                </div>
            </div>
            
            <div id="cart-footer" class="p-6 border-t border-gray-200 hidden">
                <div class="flex items-center justify-between mb-6">
                    <span class="text-xl font-semibold text-gray-800">Total TTC:</span>
                    <span id="cart-total" class="text-3xl font-bold text-green-600">0.00‚Ç¨</span>
                </div>
                
                <button onclick="proceedToCheckout()" 
                        class="w-full btn-primary text-white py-4 rounded-xl text-xl font-semibold hover:opacity-90 touch-feedback">
                    <i class="fas fa-credit-card mr-2"></i>
                    Proc√©der au paiement
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Personnalisation Produit -->
    <div id="product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl max-w-3xl w-full mx-4 max-h-screen overflow-y-auto">
            <!-- Contenu g√©n√©r√© dynamiquement -->
        </div>
    </div>

    <!-- Modal Paiement -->
    <div id="payment-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl max-w-lg w-full mx-4">
            <div class="p-8 text-center">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Choisir le mode de paiement</h3>
                
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="processCashPayment()" 
                            class="bg-green-500 text-white p-8 rounded-xl text-xl font-semibold hover:bg-green-600 touch-feedback">
                        <i class="fas fa-money-bill-wave text-6xl mb-4"></i>
                        <br>Esp√®ces
                    </button>
                    <button onclick="processCardPayment()" 
                            class="bg-blue-500 text-white p-8 rounded-xl text-xl font-semibold hover:bg-blue-600 touch-feedback">
                        <i class="fas fa-credit-card text-6xl mb-4"></i>
                        <br>Carte Bancaire
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- √âcran de confirmation -->
    <div id="confirmation-screen" class="hidden fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center p-8">
            <div class="w-32 h-32 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-8">
                <i class="fas fa-check text-6xl text-green-600"></i>
            </div>
            <h2 class="text-4xl font-bold text-gray-800 mb-4">Commande confirm√©e !</h2>
            <p class="text-xl text-gray-600 mb-2">Num√©ro de commande :</p>
            <p id="order-number" class="text-2xl font-bold text-blue-600 mb-8">#BC-000001</p>
            
            <div class="space-y-4">
                <p class="text-lg text-gray-700">Votre commande est en cours de pr√©paration</p>
                <p class="text-gray-600">Temps d'attente estim√© : <span id="estimated-time" class="font-semibold">15-20 minutes</span></p>
            </div>
            
            <button onclick="startNewOrder()" 
                    class="mt-8 btn-primary text-white px-8 py-4 rounded-xl text-lg font-semibold hover:opacity-90 touch-feedback">
                Nouvelle commande
            </button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Notifications g√©n√©r√©es dynamiquement -->
    </div>

    <script>
        // ========================================
        // CONFIGURATION ET CONSTANTES
        // ========================================
        
        // Configuration des allerg√®nes (14 obligatoires UE)
        const ALLERGENS = {
            1: { code: 'GLU', name: 'Gluten', icon: 'üåæ' },
            2: { code: 'CRU', name: 'Crustac√©s', icon: 'ü¶ê' },
            3: { code: 'EGG', name: '≈íufs', icon: 'ü•ö' },
            4: { code: 'FSH', name: 'Poisson', icon: 'üêü' },
            5: { code: 'PNT', name: 'Arachides', icon: 'ü•ú' },
            6: { code: 'SOY', name: 'Soja', icon: 'üå±' },
            7: { code: 'MLK', name: 'Lait', icon: 'ü•õ' },
            8: { code: 'NUT', name: 'Fruits √† coque', icon: 'üå∞' },
            9: { code: 'CEL', name: 'C√©leri', icon: 'ü•¨' },
            10: { code: 'MUS', name: 'Moutarde', icon: 'üü°' },
            11: { code: 'SES', name: 'Graines de s√©same', icon: '‚ö™' },
            12: { code: 'SUL', name: 'Sulfites', icon: 'üß™' },
            13: { code: 'LUP', name: 'Lupin', icon: 'üåø' },
            14: { code: 'MOL', name: 'Mollusques', icon: 'ü¶™' }
        };

        // Modes de service
        const SERVICE_MODES = {
            DINE_IN: 'sur_place',
            TAKEAWAY: 'a_emporter'
        };

        // Configuration des tables
        const TABLE_NUMBERS = Array.from({length: 20}, (_, i) => i + 1);

        // √âtat de l'application
        const appState = {
            currentScreen: 'service-mode',
            serviceMode: null,
            tableNumber: null,
            customerAllergens: [],
            cart: [],
            currentCategory: null,
            products: [],
            categories: []
        };

        // ========================================
        // INITIALISATION
        // ========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initialisation du kiosque...');
            
            try {
                // G√©n√©rer les √©l√©ments UI
                generateAllergenGrid();
                generateTableGrid();
                
                // Charger le catalogue
                await loadCatalog();
                
                // D√©marrer l'√©cran de veille si configur√©
                if (isFeatureEnabled && isFeatureEnabled('screensaver')) {
                    initScreensaver();
                }
                
                console.log('‚úÖ Kiosque initialis√© avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur d\'initialisation:', error);
                showToast('Erreur d\'initialisation', 'error');
            }
        });

        // ========================================
        // GESTION DES √âCRANS
        // ========================================
        
        function showScreen(screenId) {
            // Masquer tous les √©crans
            document.querySelectorAll('[id$="-screen"]').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Afficher l'√©cran demand√©
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.remove('hidden');
                screen.classList.add('slide-in-up');
                appState.currentScreen = screenId.replace('-screen', '');
            }
        }

        // ========================================
        // S√âLECTION DU MODE DE SERVICE
        // ========================================
        
        function setServiceMode(mode) {
            appState.serviceMode = mode;
            
            if (mode === SERVICE_MODES.DINE_IN) {
                showScreen('table-selection-screen');
            } else {
                // Mode √† emporter, passer aux allerg√®nes
                showScreen('allergen-selection-screen');
            }
        }

        function setTableNumber(tableNum) {
            appState.tableNumber = tableNum;
            showScreen('allergen-selection-screen');
        }

        function goBackToServiceMode() {
            showScreen('service-mode-screen');
        }

        // ========================================
        // GESTION DES ALLERG√àNES
        // ========================================
        
        function generateAllergenGrid() {
            const grid = document.getElementById('allergen-grid');
            if (!grid) return;
            
            grid.innerHTML = Object.entries(ALLERGENS).map(([id, allergen]) => `
                <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl hover:border-red-300 cursor-pointer transition-colors touch-feedback">
                    <input type="checkbox" 
                           class="allergen-checkbox mr-3 w-5 h-5" 
                           value="${id}"
                           onchange="toggleAllergen(${id})">
                    <span class="text-3xl mr-3">${allergen.icon}</span>
                    <span class="font-semibold">${allergen.name}</span>
                </label>
            `).join('');
        }

        function generateTableGrid() {
            const grid = document.getElementById('table-grid');
            if (!grid) return;
            
            grid.innerHTML = TABLE_NUMBERS.map(num => `
                <button onclick="setTableNumber(${num})" 
                        class="bg-white border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 p-8 rounded-xl text-xl font-semibold transition-colors touch-feedback">
                    Table ${num}
                </button>
            `).join('');
        }

        function toggleAllergen(allergenId) {
            const index = appState.customerAllergens.indexOf(allergenId);
            if (index === -1) {
                appState.customerAllergens.push(allergenId);
            } else {
                appState.customerAllergens.splice(index, 1);
            }
        }

        function skipAllergenSelection() {
            appState.customerAllergens = [];
            proceedToMenu();
        }

        function confirmAllergenSelection() {
            if (appState.customerAllergens.length > 0) {
                showToast(`Filtre appliqu√© pour ${appState.customerAllergens.length} allerg√®ne(s)`, 'success');
            }
            proceedToMenu();
        }

        function proceedToMenu() {
            showScreen('main-menu-screen');
            renderCategories();
            renderProducts();
        }

        // ========================================
        // GESTION DU CATALOGUE
        // ========================================
        
        async function loadCatalog() {
            try {
                // Simuler le chargement du catalogue
                // En production, remplacer par un appel API r√©el
                appState.categories = [
                    { id: 1, name: 'Burgers', icon: 'üçî', active: true },
                    { id: 2, name: 'Salades', icon: 'ü•ó', active: true },
                    { id: 3, name: 'Boissons', icon: 'ü•§', active: true },
                    { id: 4, name: 'Desserts', icon: 'üç∞', active: true },
                    { id: 5, name: 'Menus', icon: 'üçΩÔ∏è', active: true }
                ];

                appState.products = [
                    {
                        id: 1,
                        name: 'Burger Classic',
                        description: 'Pain de b≈ìuf, salade, tomates, cornichons',
                        price: 12.50,
                        category_id: 1,
                        image_url: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=300&h=200&fit=crop',
                        allergens: [1, 3, 7], // Gluten, ≈íufs, Lait
                        options: {
                            sizes: [
                                { id: 'normal', name: 'Normal', price: 0 },
                                { id: 'maxi', name: 'Maxi', price: 2.50 }
                            ],
                            extras: [
                                { id: 'bacon', name: 'Bacon suppl√©mentaire', price: 1.50 },
                                { id: 'cheese', name: 'Fromage suppl√©mentaire', price: 1.00 }
                            ]
                        }
                    },
                    {
                        id: 2,
                        name: 'Salade C√©sar',
                        description: 'Salade, poulet grill√©, parmesan, cro√ªtons',
                        price: 9.90,
                        category_id: 2,
                        image_url: 'https://images.unsplash.com/photo-1540420773420-3366772f4999?w=300&h=200&fit=crop',
                        allergens: [1, 3, 4, 7], // Gluten, ≈íufs, Poisson, Lait
                        options: {
                            extras: [
                                { id: 'chicken_extra', name: 'Double portion poulet', price: 3.00 }
                            ]
                        }
                    },
                    {
                        id: 3,
                        name: 'Coca-Cola',
                        description: 'Boisson gazeuse',
                        price: 2.50,
                        category_id: 3,
                        image_url: 'https://images.unsplash.com/photo-1581636625402-29d2d0b5c9c0?w=300&h=200&fit=crop',
                        allergens: [],
                        options: {
                            sizes: [
                                { id: 'small', name: 'Petit (33cl)', price: 0 },
                                { id: 'medium', name: 'Moyen (50cl)', price: 0.50 },
                                { id: 'large', name: 'Grand (75cl)', price: 1.00 }
                            ]
                        }
                    }
                ];

                appState.currentCategory = appState.categories[0]?.id || null;
                
            } catch (error) {
                console.error('Erreur chargement catalogue:', error);
                showToast('Erreur de chargement du menu', 'error');
            }
        }

        function renderCategories() {
            const nav = document.getElementById('categories-nav');
            if (!nav || !appState.categories.length) return;
            
            nav.innerHTML = appState.categories.map(category => `
                <button onclick="selectCategory(${category.id})" 
                        class="category-btn flex-shrink-0 px-6 py-3 rounded-full text-lg font-semibold transition-colors touch-feedback ${
                            appState.currentCategory === category.id 
                                ? 'bg-blue-500 text-white' 
                                : 'bg-white text-gray-700 hover:bg-gray-100'
                        }">
                    <span class="mr-2">${category.icon}</span>
                    ${category.name}
                </button>
            `).join('');
        }

        function selectCategory(categoryId) {
            appState.currentCategory = categoryId;
            renderCategories();
            renderProducts();
        }

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            if (!grid) return;
            
            const filteredProducts = appState.products.filter(product => 
                product.category_id === appState.currentCategory &&
                isProductSafeForAllergens(product)
            );
            
            if (filteredProducts.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-gray-400 mb-4"></i>
                        <p class="text-xl text-gray-500">Aucun produit disponible dans cette cat√©gorie</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer touch-feedback"
                     onclick="openProductModal(${product.id})">
                    <div class="relative">
                        <img src="${product.image_url}" 
                             alt="${product.name}" 
                             class="w-full h-48 object-cover">
                        ${renderAllergenBadges(product.allergens)}
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-4">${product.description}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-bold text-green-600">${product.price.toFixed(2)}‚Ç¨</span>
                            <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-plus mr-1"></i>Ajouter
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function isProductSafeForAllergens(product) {
            if (appState.customerAllergens.length === 0) return true;
            
            return !product.allergens.some(allergenId => 
                appState.customerAllergens.includes(allergenId)
            );
        }

        function renderAllergenBadges(allergens) {
            if (!allergens || allergens.length === 0) return '';
            
            return `
                <div class="absolute top-2 left-2">
                    <div class="flex flex-wrap gap-1">
                        ${allergens.map(allergenId => {
                            const allergen = ALLERGENS[allergenId];
                            return allergen ? `
                                <span class="allergen-badge bg-red-100 text-red-800" title="${allergen.name}">
                                    ${allergen.icon} ${allergen.code}
                                </span>
                            ` : '';
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // ========================================
        // MODAL PRODUIT ET PERSONNALISATION
        // ========================================
        
        function openProductModal(productId) {
            const product = appState.products.find(p => p.id === productId);
            if (!product) return;
            
            const modal = document.getElementById('product-modal');
            modal.innerHTML = generateProductModalContent(product);
            modal.classList.remove('hidden');
        }

        function generateProductModalContent(product) {
            return `
                <div class="bg-white rounded-2xl max-w-3xl w-full mx-4 max-h-screen overflow-y-auto">
                    <div class="relative">
                        <img src="${product.image_url}" alt="${product.name}" class="w-full h-64 object-cover">
                        <button onclick="closeProductModal()" 
                                class="absolute top-4 right-4 bg-white text-gray-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">${product.name}</h2>
                        <p class="text-gray-600 mb-4">${product.description}</p>
                        <div class="text-3xl font-bold text-green-600 mb-6">${product.price.toFixed(2)}‚Ç¨</div>
                        
                        ${product.options && product.options.sizes ? `
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Choisir la taille</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    ${product.options.sizes.map((size, index) => `
                                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-300 transition-colors">
                                            <input type="radio" name="size" value="${size.id}" class="mr-2" ${index === 0 ? 'checked' : ''}>
                                            <div>
                                                <div class="font-semibold">${size.name}</div>
                                                ${size.price > 0 ? `<div class="text-sm text-green-600">+${size.price.toFixed(2)}‚Ç¨</div>` : ''}
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${product.options && product.options.extras ? `
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Suppl√©ments & Options</h3>
                                <div class="space-y-2">
                                    ${product.options.extras.map(extra => `
                                        <label class="flex items-center justify-between p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                                            <div class="flex items-center">
                                                <input type="checkbox" name="extras" value="${extra.id}" class="mr-3">
                                                <span>${extra.name}</span>
                                            </div>
                                            <span class="text-green-600 font-semibold">+${extra.price.toFixed(2)}‚Ç¨</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Quantit√©</h3>
                            <div class="flex items-center space-x-4">
                                <button onclick="decreaseQuantity()" class="bg-gray-200 hover:bg-gray-300 w-10 h-10 rounded-full flex items-center justify-center">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span id="quantity" class="text-2xl font-bold">1</span>
                                <button onclick="increaseQuantity()" class="bg-gray-200 hover:bg-gray-300 w-10 h-10 rounded-full flex items-center justify-center">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Instructions sp√©ciales</h3>
                            <textarea id="special-instructions" 
                                      class="w-full p-3 border border-gray-300 rounded-lg resize-none" 
                                      rows="3" 
                                      placeholder="Ex: Bien cuit, sans sel, etc..."></textarea>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button onclick="closeProductModal()" 
                                    class="flex-1 bg-gray-300 text-gray-700 py-4 rounded-xl text-lg font-semibold hover:bg-gray-400 touch-feedback">
                                Annuler
                            </button>
                            <button onclick="addToCart(${product.id})" 
                                    class="flex-1 btn-primary text-white py-4 rounded-xl text-lg font-semibold hover:opacity-90 touch-feedback">
                                Ajouter au panier
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        // ========================================
        // GESTION DU PANIER
        // ========================================
        
        function addToCart(productId) {
            const product = appState.products.find(p => p.id === productId);
            if (!product) return;

            const quantity = parseInt(document.getElementById('quantity').textContent) || 1;
            const specialInstructions = document.getElementById('special-instructions').value;

            // R√©cup√©rer les options s√©lectionn√©es
            const selectedSize = document.querySelector('input[name="size"]:checked');
            const selectedExtras = Array.from(document.querySelectorAll('input[name="extras"]:checked'));

            let totalPrice = product.price * quantity;
            const options = [];

            // Ajouter le prix de la taille
            if (selectedSize) {
                const size = product.options.sizes.find(s => s.id === selectedSize.value);
                if (size && size.price > 0) {
                    totalPrice += size.price * quantity;
                    options.push({ type: 'size', name: size.name, price: size.price });
                }
            }

            // Ajouter le prix des extras
            selectedExtras.forEach(extraInput => {
                const extra = product.options.extras.find(e => e.id === extraInput.value);
                if (extra) {
                    totalPrice += extra.price * quantity;
                    options.push({ type: 'extra', name: extra.name, price: extra.price });
                }
            });

            const cartItem = {
                id: Date.now(), // ID unique pour l'item du panier
                product_id: product.id,
                product_name: product.name,
                quantity: quantity,
                unit_price: product.price,
                total_price: totalPrice,
                options: options,
                special_instructions: specialInstructions,
                image_url: product.image_url
            };

            appState.cart.push(cartItem);
            updateCartUI();
            closeProductModal();
            showToast(`${product.name} ajout√© au panier`, 'success');
        }

        function updateCartUI() {
            const cartCount = document.getElementById('cart-count');
            const cartButton = document.getElementById('cart-button');
            
            if (appState.cart.length > 0) {
                cartCount.textContent = appState.cart.length;
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
        }

        function openCartModal() {
            const modal = document.getElementById('cart-modal');
            renderCartItems();
            modal.classList.remove('hidden');
        }

        function closeCartModal() {
            document.getElementById('cart-modal').classList.add('hidden');
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            const footer = document.getElementById('cart-footer');
            
            if (appState.cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-shopping-cart text-6xl mb-4 opacity-50"></i>
                        <p class="text-xl">Votre panier est vide</p>
                    </div>
                `;
                footer.classList.add('hidden');
                return;
            }

            let total = 0;
            container.innerHTML = appState.cart.map(item => {
                total += item.total_price;
                return `
                    <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                        <img src="${item.image_url}" alt="${item.product_name}" class="w-16 h-16 object-cover rounded">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${item.product_name}</h4>
                            <p class="text-sm text-gray-600">Quantit√©: ${item.quantity}</p>
                            ${item.options.map(opt => `
                                <p class="text-xs text-gray-500">+ ${opt.name} (+${opt.price.toFixed(2)}‚Ç¨)</p>
                            `).join('')}
                            ${item.special_instructions ? `
                                <p class="text-xs text-blue-600">Note: ${item.special_instructions}</p>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-green-600">${item.total_price.toFixed(2)}‚Ç¨</p>
                            <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700 text-sm">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('cart-total').textContent = `${total.toFixed(2)}‚Ç¨`;
            footer.classList.remove('hidden');
        }

        function removeFromCart(itemId) {
            appState.cart = appState.cart.filter(item => item.id !== itemId);
            updateCartUI();
            renderCartItems();
            showToast('Article supprim√© du panier', 'info');
        }

        // ========================================
        // PROCESSUS DE PAIEMENT
        // ========================================
        
        function proceedToCheckout() {
            if (appState.cart.length === 0) {
                showToast('Votre panier est vide', 'warning');
                return;
            }

            closeCartModal();
            document.getElementById('payment-modal').classList.remove('hidden');
        }

        async function processCashPayment() {
            try {
                const order = await createOrder('cash');
                if (order.success) {
                    showConfirmationScreen(order);
                }
            } catch (error) {
                console.error('Erreur paiement esp√®ces:', error);
                showToast('Erreur lors du paiement', 'error');
            }
        }

        async function processCardPayment() {
            try {
                const order = await createOrder('card');
                if (order.success) {
                    showConfirmationScreen(order);
                }
            } catch (error) {
                console.error('Erreur paiement carte:', error);
                showToast('Erreur lors du paiement', 'error');
            }
        }

        async function createOrder(paymentMethod) {
            const orderData = {
                items: appState.cart,
                customer_name: `Client ${appState.serviceMode === 'sur_place' ? `Table ${appState.tableNumber}` : '√Ä emporter'}`,
                service_mode: appState.serviceMode,
                table_number: appState.tableNumber,
                order_type: 'kiosk',
                payment_method: paymentMethod,
                customer_allergens: appState.customerAllergens
            };

            // En production, remplacer par un appel API r√©el
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        success: true,
                        order_number: `BC-${String(Date.now()).slice(-6)}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`,
                        estimated_time: '15-20 minutes'
                    });
                }, 1000);
            });
        }

        function showConfirmationScreen(order) {
            document.getElementById('payment-modal').classList.add('hidden');
            document.getElementById('order-number').textContent = `#${order.order_number}`;
            document.getElementById('estimated-time').textContent = order.estimated_time;
            document.getElementById('confirmation-screen').classList.remove('hidden');
        }

        function startNewOrder() {
            // R√©initialiser l'√©tat
            appState.cart = [];
            appState.serviceMode = null;
            appState.tableNumber = null;
            appState.customerAllergens = [];
            
            // Masquer l'√©cran de confirmation
            document.getElementById('confirmation-screen').classList.add('hidden');
            
            // R√©initialiser les checkboxes allerg√®nes
            document.querySelectorAll('.allergen-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Retourner √† l'√©cran de s√©lection du service
            showScreen('service-mode-screen');
            updateCartUI();
        }

        // ========================================
        // UTILITAIRES
        // ========================================
        
        function increaseQuantity() {
            const quantityEl = document.getElementById('quantity');
            const current = parseInt(quantityEl.textContent);
            if (current < 20) { // Limite max
                quantityEl.textContent = current + 1;
            }
        }

        function decreaseQuantity() {
            const quantityEl = document.getElementById('quantity');
            const current = parseInt(quantityEl.textContent);
            if (current > 1) {
                quantityEl.textContent = current - 1;
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 slide-in-up`;
            toast.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function initScreensaver() {
            let inactivityTimer;
            const SCREENSAVER_DELAY = 5 * 60 * 1000; // 5 minutes
            
            function resetTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    // Activer l'√©cran de veille
                    console.log('Activation √©cran de veille');
                }, SCREENSAVER_DELAY);
            }
            
            // √âcouter les √©v√©nements d'activit√©
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetTimer, true);
            });
            
            resetTimer();
        }

        // Gestion de la connectivit√©
        window.addEventListener('online', () => {
            document.getElementById('connection-indicator').innerHTML = '<i class="fas fa-wifi mr-2"></i>En ligne';
            document.getElementById('connection-indicator').className = 'bg-green-500 text-white px-4 py-2 rounded-full text-sm';
        });

        window.addEventListener('offline', () => {
            document.getElementById('connection-indicator').innerHTML = '<i class="fas fa-wifi-slash mr-2"></i>Hors ligne';
            document.getElementById('connection-indicator').className = 'bg-red-500 text-white px-4 py-2 rounded-full text-sm';
        });

        // Gestion des erreurs globales
        window.addEventListener('error', (event) => {
            console.error('Erreur globale:', event.error);
            if (CONFIG && CONFIG.DEBUG && CONFIG.DEBUG.SHOW_ERRORS) {
                showToast('Une erreur est survenue', 'error');
            }
        });

        // Export des fonctions pour les tests
        window.kioskApp = {
            setServiceMode,
            setTableNumber,
            toggleAllergen,
            openProductModal,
            addToCart,
            showToast
        };
    </script>
</body>
</html>